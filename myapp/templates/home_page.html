{% comment %} {% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'home.css' %}"> 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://getbootstrap.com/docs/5.3/assets/css/docs.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: auto;
            right: 0;
            transform: translateX(0); /* Ensures dropdown aligns properly */
            z-index: 1000;
            width: auto; /* Optional: Adjust width */
            min-width: 150px; /* Adjust based on your content */
            max-width: 90vw; /* Ensures it doesn't overflow on smaller screens */
            overflow: hidden; /* Prevent content from overflowing */
            border-radius: 15px;
        }
        
        .dropdown-menu .dropdown-item {
            white-space: nowrap; /* Prevents text from wrapping */
        }
        
        .navbar {
            padding-right: 1rem; /* Ensures the navbar content is well-aligned */
        }
        
        img.rounded-circle {
            object-fit: cover; /* Ensures the image fits the container without stretching */
            border-radius: 50%; /* Creates the rounded shape */
            width: 28px; /* Set the width to the desired size */
            height: 28px; /* Set the height to the desired size */
           
        }

        #username_homepage{
            color: rgb(58, 179, 134);
            font-weight: 600;
        }

        .navbar-brand{
            margin-left:12px;
        }

        .offcanvas-start {
            width: 250px; /* Sidebar width */
        }

        .history-toggle-btn {
            position: absolute;
            top: autopx;
            bottom: 0px;
            z-index: 1100; /* Ensure it stays above the rest of the layout */
            margin-left:10px;
        }

    </style>
</head>
<body>
    <header>
        <nav class="navbar navbar-light justify-content-between fixed-top">
            <a class="navbar-brand">Chat</a>
            <div class="dropdown">
                <a role="button" href="" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <img src="{% static 'icons/pro.png' %}" class="rounded-circle" width="20" height="20">
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuLink">
                    <a class="dropdown-item" href="{% url 'profile_page' %}">Profile</a>
                    <a class="dropdown-item" href="#" data-toggle="modal" data-target="#logoutModal">Logout</a>
                </div>
            </div>
        </nav>
        <button class="btn btn-primary history-toggle-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#conversationHistory" aria-controls="conversationHistory">
            History
        </button>
    
        <!-- Offcanvas Sidebar for Conversation History -->
        <div class="offcanvas offcanvas-start" tabindex="-1" id="conversationHistory" aria-labelledby="conversationHistoryLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="conversationHistoryLabel">Conversation History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <ul class="list-group">
                    {% for conversation in conversation_history %}
                        <li class="list-group-item">You: {{ conversation.user_input }} <br> AI: {{ conversation.ai_response }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        
        <!-- Logout Confirmation Modal -->
        <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="logoutModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="logoutModalLabel">Confirm Logout</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        Are you sure you want to log out?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <form action="{% url 'logout_view' %}" method="post" id="logout-form">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">Logout</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container mt-5 pt-5">
        <div class="content">
            <h2>Welcome back, <span id="username_homepage">{{ username }}</span></h2>
            <h2>Select a language model to continue.</h2>
    
            <form method="POST" action="{% url 'ai_interaction' %}">
                {% csrf_token %}
                <div class="p-3 m-0 border-0 bd-example m-0 border-0" id="select_div">
                    <select class="form-select" name="model" aria-label="Select a Model" required>
                        <option value="chatgpt">Gemini</option>
                        <option value="gemini">Chat GPT</option>
                        <option value="anthropic">Anthropic AI</option>
                    </select>
                </div>
    
                <div id="messages">
                    {% if conversation_history %}
                        {% for conversation in conversation_history %}
                            <div><strong>You:</strong> {{ conversation.user_input }}</div>
                            <div><strong>AI:</strong> {{ conversation.ai_response }}</div>
                        {% endfor %}
                    {% endif %}
                </div>
    
                <div class="message-box">
                    <div class="message-box-inner d-flex align-items-end">
                        <button class="attach_button bottom-button">
                            <img src="{% static 'icons/attach.png' %}" style="width: 9px; padding-bottom: 2px;">
                        </button>
                        <textarea id="message-input" class="form-control" name="message" rows="1" placeholder="Type a message..." required></textarea>
                        <button class="send_button bottom-button" type="submit">Send</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        const textarea = document.getElementById('message-input');
        const maxLines = 10; // Maximum number of lines
        const lineHeight = 24; // Adjust based on the actual line-height of your textarea, in pixels
    
        textarea.addEventListener('input', function() {
            this.style.height = 'auto'; // Reset the height to auto before calculating
            const lines = Math.floor(this.scrollHeight / lineHeight); // Calculate how many lines of text there are
            const maxHeight = lineHeight * maxLines; // The maximum height based on the number of lines
    
            if (this.scrollHeight > maxHeight) {
                this.style.height = maxHeight + 'px'; // Cap the height if the scrollHeight exceeds the maximum
                this.style.overflowY = 'scroll'; // Show scrollbar when exceeding max lines
            } else {
                this.style.height = this.scrollHeight + 'px'; // Adjust the height to fit the content
                this.style.overflowY = 'hidden'; // Hide scrollbar if within limit
            }
        });

        const form = document.querySelector('form');
    const messageInput = document.querySelector('#message-input');
    const messagesDiv = document.querySelector('#messages');

    form.addEventListener('submit', function(e) {
        e.preventDefault();  // Prevent default form submission behavior

        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'  // Dynamically include CSRF token
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            return response.json();  // Parse JSON response
        })
        .then(data => {
            // Clear the message input
            messageInput.value = '';

            // Append user message and AI response dynamically
            messagesDiv.innerHTML += `<div><strong>You:</strong> ${data.message}</div>`;
            if (data.response) {
                messagesDiv.innerHTML += `<div><strong>AI:</strong> ${data.response}</div>`;
            } else if (data.error) {
                messagesDiv.innerHTML += `<div class="text-danger"><strong>Error:</strong> ${data.error}</div>`;
            }
        })
        .catch(error => {
            // Handle network or unexpected errors
            messagesDiv.innerHTML += `<div class="text-danger"><strong>Error:</strong> ${error.message}</div>`;
        });
    });
    </script>

<!-- Bootstrap JS, Popper.js, and jQuery -->
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

</body>
</html> {% endcomment %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet"href="{% static 'home.css' %}" >

    <style>
        body, html {
          height: 100%;
        }
    
        .messages-box {
          flex: 1;
          overflow-y: auto;
        }
    
        .messages-list {
          padding-left: 0;
        }
    
        .message {
          margin-bottom: 15px;
          list-style: none;
        }
    
        .message-text {
          padding: 10px;
          border-radius: 5px;
        }
    
        .sent {
          background-color: #dcf8c6;
          align-self: flex-end;
        }
    
        .received {
          background-color: #f1f0f0;
          align-self: flex-start;
        }
    
        .message-form {
          display: flex;
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          padding: 10px;
          background-color: #f8f9fa;
        }
    
        .message-input {
          flex: 1;
          border-radius: 0;
          border-right: none;
        }
    
        .btn-send {
          border-radius: 0;
        }
    
        .chat-container {
          height: 100%;
          display: flex;
          flex-direction: column;
        }
            
            .navbar {
                padding-right: 1rem; /* Ensures the navbar content is well-aligned */
            }
            
            img.rounded-circle {
                object-fit: cover; /* Ensures the image fits the container without stretching */
                border-radius: 50%; /* Creates the rounded shape */
                width: 28px; /* Set the width to the desired size */
                height: 28px; /* Set the height to the desired size */
               
            }
    
            #username_homepage{
                color: rgb(58, 179, 134);
                font-weight: 600;
            }
    
            .navbar-brand{
                margin-left:12px;
            }
    
            .offcanvas-start {
                width: 250px; /* Sidebar width */
            }
    
            .history-toggle-btn {
                position: absolute;
                top: autopx;
                bottom: 55px;
                z-index: 1100; /* Ensure it stays above the rest of the layout */
                margin-left:10px;
            }
    
            .sent {
                background-color: #dcf8c6;
                align-self: flex-end;
              }
          
              .received {
                background-color: #f1f0f0;
                align-self: flex-start;
              }
    
              .message-text {
                padding: 10px;
                border-radius: 5px;
              }
    
              .message {
                margin-bottom: 15px;
                list-style: none;
              }
    
              .message-form {
                display: flex;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                padding: 10px;
                background-color: #f8f9fa;
              }
      </style>
    
</head>

<body>
    <header>
        <nav class="navbar navbar-light justify-content-between fixed-top">
            <a class="navbar-brand">Chat</a>
            <div class="dropdown">
                <a role="button" href="" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <img src="{% static 'icons/pro.png' %}" class="rounded-circle" width="20" height="20">
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuLink">
                    <a class="dropdown-item" href="{% url 'profile_page' %}">Profile</a>
                    <a class="dropdown-item" href="#" data-toggle="modal" data-target="#logoutModal">Logout</a>
                </div>
            </div>
        </nav>
        <button class="btn btn-primary history-toggle-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#conversationHistory" aria-controls="conversationHistory">
            History
        </button>
    
        <!-- Offcanvas Sidebar for Conversation History -->
        {% comment %} <div class="offcanvas offcanvas-start" tabindex="-1" id="conversationHistory" aria-labelledby="conversationHistoryLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="conversationHistoryLabel">Conversation History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <ul class="list-group">
                    {% for conversation in conversation_history %}
                        <li class="list-group-item">You: {{ conversation.user_input }} <br> AI: {{ conversation.ai_response }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div> {% endcomment %}
        
        <!-- Logout Confirmation Modal -->
        <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="logoutModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="logoutModalLabel">Confirm Logout</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        Are you sure you want to log out?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <form action="{% url 'logout_view' %}" method="post" id="logout-form">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">Logout</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container mt-5 pt-5">
        <div class="content">
            <h2>Welcome back, <span id="username_homepage">{{ username }}</span></h2>
            <h2>Select a language model to continue.</h2>

            <div class="chat-container">
                <div class="card flex-grow-1">
                  <div class="card-body messages-box">
                    
                    <ul class="list-unstyled messages-list">
                      {% for chat in chats %}
                        {% if chat.user == request.user %}
              
                          <li class="message sent">
                        <div class="message-text">
                          <div class="message-sender">
                            <b>You</b>
                          </div>
                          <div class="message-content">
                            {{chat.message}}
                          </div>
                        </div>
                      </li>
              
                      <li class="message received">
                        <div class="message-text">
                          <div class="message-sender">
                            <b>AI Chatbot</b>
                          </div>
                          <div class="message-content">
                            {{chat.response}}
                          </div>
                        </div>
                      </li>
              
                        {% endif %}
                      {% endfor %}
                      
                    </ul>
                    
                  </div>
        <form method="POST" action="{% url 'ai_interaction' %}" class="message-form">
          {%csrf_token%}
          <div class="input-group">
            <input type="text" class="form-control message-input" placeholder="Type your message...">
            <div class="input-group-append">
              <button type="submit" class="btn btn-primary btn-send">Send</button>
            </div>
          </div>
        </form>
      </div>

    <script>
        const messagesList = document.querySelector('.messages-list');
        const messageForm = document.querySelector('.message-form');
        const messageInput = document.querySelector('.message-input');

        messageForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const message = messageInput.value.trim();
            if (message.length === 0) {
                return;
            }

            // Append the user's message
            const userMessageItem = document.createElement('li');
            userMessageItem.classList.add('message', 'sent');
            userMessageItem.innerHTML = `
                <div class="message-text">
                    <div class="message-sender">
                        <b>You</b>
                    </div>
                    <div class="message-content">
                        ${message}
                    </div>
                </div>`;
            messagesList.appendChild(userMessageItem);

            messageInput.value = '';

            // Send the message to the server
            fetch(messageForm.action, {
                method: 'POST',
                headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value // Include CSRF token
                },
                body: new URLSearchParams({
                'message': message
                })
            })
            .then(response => {
                if (!response.ok) {
                throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Handle AI response
                const aiMessageItem = document.createElement('li');
                aiMessageItem.classList.add('message', 'received');
                aiMessageItem.innerHTML = `
                <div class="message-text">
                    <div class="message-sender">
                    <b>AI Chatbot</b>
                    </div>
                    <div class="message-content">
                        ${data.response || data.error}
                    </div>
                </div>`;
                messagesList.appendChild(aiMessageItem);
            })
            .catch(error => {
                const errorMessageItem = document.createElement('li');
                errorMessageItem.classList.add('message', 'received');
                errorMessageItem.innerHTML = `
                <div class="message-text">
                    <div class="message-sender">
                    <b>Error</b>
                    </div>
                    <div class="message-content">
                        ${error.message}
                    </div>
                </div>`;
                messagesList.appendChild(errorMessageItem);
            });
        });
    </script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
</body>
</html>